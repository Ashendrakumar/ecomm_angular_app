@if (isLoading()) {
  <div class="pdp-loading">
    <div class="spinner-border text-gold" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
}
@if (!isLoading() && product()) {
  <div class="pdp">
    <div class="container pdp__container">
      <div class="row g-4 g-lg-5">
        <!-- Image gallery with slider -->
        <div class="col-lg-6">
          <div class="pdp-gallery">
            <div class="pdp-gallery__main">
              <img
                [src]="
                  selectedImage() ||
                  product()!.images[0] ||
                  'https://placehold.co/600x600?text=No+Image'
                "
                [alt]="product()!.name"
                class="pdp-gallery__img"
              />
              @if (galleryImages().length > 1) {
                <button
                  type="button"
                  class="pdp-gallery__nav pdp-gallery__nav--prev"
                  aria-label="Previous image"
                  (click)="prevImage()"
                >
                  <span aria-hidden="true">‹</span>
                </button>
                <button
                  type="button"
                  class="pdp-gallery__nav pdp-gallery__nav--next"
                  aria-label="Next image"
                  (click)="nextImage()"
                >
                  <span aria-hidden="true">›</span>
                </button>
              }
            </div>
            @if (galleryImages().length > 1) {
              <div class="pdp-gallery__dots">
                @for (img of galleryImages(); track img; let i = $index) {
                  <button
                    type="button"
                    class="pdp-gallery__dot"
                    [class.pdp-gallery__dot--active]="galleryIndex() === i"
                    [attr.aria-label]="'Image ' + (i + 1)"
                    (click)="goToImageIndex(i)"
                  ></button>
                }
              </div>
              <div class="pdp-gallery__thumbs">
                @for (image of galleryImages(); track image; let i = $index) {
                  <button
                    type="button"
                    class="pdp-gallery__thumb"
                    [class.pdp-gallery__thumb--active]="galleryIndex() === i"
                    (click)="selectImage(image)"
                  >
                    <img [src]="image" [alt]="product()!.name + ' thumbnail'" />
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Product info -->
        <div class="col-lg-6">
          <div class="pdp-info">
            <div class="pdp-info__header">
              <button type="button" class="pdp-info__back" (click)="goBack()">← Back</button>
              <span class="pdp-info__brand">{{ product()!.brand }}</span>
            </div>

            <h1 class="pdp-info__title">{{ product()!.name }}</h1>
            <p class="pdp-info__description">{{ product()!.description }}</p>

            <!-- Price & offers -->
            <div class="pdp-price-card">
              <div class="pdp-price-card__row">
                <span class="pdp-price-card__current">${{ getCurrentPriceFormatted() }}</span>
                @if (
                  product()!.originalPrice != null && product()!.originalPrice! > currentPrice()
                ) {
                  <span class="pdp-price-card__original">${{ getOriginalPriceFormatted() }}</span>
                  <span class="pdp-price-card__badge">{{ discountPercentage() }}% OFF</span>
                }
              </div>
              <div class="pdp-price-card__stock">
                @if (isVariantInStock()) {
                  <span class="pdp-price-card__stock-in"
                    >In Stock ({{ currentStockQuantity() }} available)</span
                  >
                } @else {
                  <span class="pdp-price-card__stock-out">Out of Stock</span>
                }
              </div>
            </div>

            <!-- Variants -->
            @if (product()!.variants && product()!.variants!.length) {
              <div class="pdp-variants">
                @for (variant of product()!.variants; track variant.id) {
                  <div class="pdp-variants__group">
                    <label class="pdp-variants__label">{{ variant.name }}</label>
                    <div class="pdp-variants__options">
                      @for (option of variant.options; track option.id) {
                        <button
                          type="button"
                          class="pdp-variants__btn"
                          [class.pdp-variants__btn--selected]="
                            isVariantSelected(variant.id, option.id)
                          "
                          [class.pdp-variants__btn--disabled]="!option.inStock"
                          [disabled]="!option.inStock"
                          (click)="selectVariant(variant.id, option)"
                        >
                          {{ option.value }}
                          @if (!option.inStock) {
                            <span class="pdp-variants__oos">OOS</span>
                          }
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Quantity -->
            @if (isVariantInStock()) {
              <div class="pdp-qty">
                <label class="pdp-qty__label">Quantity</label>
                <div class="pdp-qty__controls">
                  <button
                    type="button"
                    class="pdp-qty__btn"
                    (click)="decreaseQuantity()"
                    [disabled]="quantity() <= 1"
                    aria-label="Decrease quantity"
                  >
                    −
                  </button>
                  <input
                    type="number"
                    class="pdp-qty__input"
                    [value]="quantity()"
                    (input)="onQuantityChange($event)"
                    min="1"
                    [max]="currentStockQuantity()"
                    aria-label="Quantity"
                  />
                  <button
                    type="button"
                    class="pdp-qty__btn"
                    (click)="increaseQuantity()"
                    [disabled]="quantity() >= currentStockQuantity()"
                    aria-label="Increase quantity"
                  >
                    +
                  </button>
                </div>
              </div>
            }

            <!-- Add to Cart -->
            <div class="pdp-actions">
              <button
                type="button"
                class="pdp-actions__add"
                [disabled]="!canAddToCart()"
                (click)="addToCart()"
              >
                @if (isAddingToCart()) {
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Adding...
                } @else {
                  Add to Cart
                }
              </button>
              <button type="button" class="pdp-actions__secondary" (click)="goBack()">
                Continue Shopping
              </button>
            </div>

            @if (
              product()!.variants &&
              product()!.variants!.length &&
              !canAddToCart() &&
              isVariantInStock()
            ) {
              <p class="pdp-actions__hint">Select all options above to add to cart.</p>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}
@if (!isLoading() && !product()) {
  <div class="container text-center py-5">
    <div class="pdp-not-found">
      <h2 class="pdp-not-found__title">Product Not Found</h2>
      <p class="pdp-not-found__text">The product you're looking for doesn't exist.</p>
      <a routerLink="/products" class="btn btn-primary">Browse Products</a>
    </div>
  </div>
}
