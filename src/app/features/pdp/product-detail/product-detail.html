@if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-gold" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
}

@if (!isLoading() && product()) {
  <div class="container">
    <div class="row">
      <!-- Product Images -->
      <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="card bg-dark-custom mb-3">
          <img
            [src]="selectedImage() || product()!.images[0] || 'https://via.placeholder.com/500x500'"
            [alt]="product()!.name"
            class="card-img-top"
            style="max-height: 520px; object-fit: contain"
          />
        </div>
        @if (product()!.images.length > 1) {
          <div class="d-flex gap-2 flex-wrap">
            @for (image of product()!.images; track image) {
              <img
                [src]="image"
                [alt]="product()!.name"
                class="img-thumbnail"
                [class.active]="selectedImage() === image"
                (click)="selectImage(image)"
                style="width: 80px; height: 80px; object-fit: cover; cursor: pointer"
              />
            }
          </div>
        }
      </div>

      <!-- Product Info -->
      <div class="col-lg-6">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <button type="button" class="btn btn-link text-decoration-none p-0" (click)="goBack()">
            ‚Üê Back
          </button>
          <span class="badge bg-secondary">{{ product()!.brand }}</span>
        </div>

        <h1 class="h3 mb-2">{{ product()!.name }}</h1>
        <p class="text-muted mb-3">{{ product()!.description }}</p>

        <!-- Price -->
        <div class="card bg-dark-custom mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center gap-3 flex-wrap">
              <span class="h3 text-gold mb-0">${{ getCurrentPriceFormatted() }}</span>
              @if (product()!.originalPrice && (product()!.originalPrice ?? 0 > currentPrice())) {
                <span class="text-muted text-decoration-line-through">
                  ${{ getOriginalPriceFormatted() }}
                </span>
                <span class="badge bg-success">{{ discountPercentage() }}% OFF</span>
              }
            </div>
            <div class="mt-3">
              @if (isVariantInStock()) {
                <span class="badge bg-success fs-6"
                  >In Stock ({{ currentStockQuantity() }} available)</span
                >
              } @else {
                <span class="badge bg-danger fs-6">Out of Stock</span>
              }
            </div>
          </div>
        </div>

        <!-- Variants -->
        @if (product()!.variants && product()!.variants!.length) {
          <div class="card bg-dark-custom mb-3">
            <div class="card-body">
              @for (variant of product()!.variants; track variant.id) {
                <div class="mb-3 pb-2 border-bottom border-secondary">
                  <label class="form-label fw-bold">{{ variant.name }}</label>
                  <div class="d-flex gap-2 flex-wrap">
                    @for (option of variant.options; track option.id) {
                      <button
                        type="button"
                        class="btn"
                        [class.btn-primary]="isVariantSelected(variant.id, option.id)"
                        [class.btn-outline-secondary]="!isVariantSelected(variant.id, option.id)"
                        [disabled]="!option.inStock"
                        (click)="selectVariant(variant.id, option)"
                      >
                        {{ option.value }}
                        @if (!option.inStock) {
                          <span class="badge bg-danger ms-1">OOS</span>
                        }
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Quantity Selector -->
        @if (isVariantInStock()) {
          <div class="card bg-dark-custom mb-3">
            <div class="card-body">
              <label class="form-label fw-bold">Quantity</label>
              <div class="input-group" style="max-width: 220px">
                <button
                  class="btn btn-outline-primary"
                  type="button"
                  (click)="decreaseQuantity()"
                  [disabled]="quantity() <= 1"
                >
                  -
                </button>
                <input
                  type="number"
                  class="form-control text-center"
                  [value]="quantity()"
                  (input)="onQuantityChange($event)"
                  min="1"
                  style="border-color: var(--accent-gold)"
                  [max]="currentStockQuantity()"
                />
                <button
                  class="btn btn-outline-primary"
                  type="button"
                  (click)="increaseQuantity()"
                  [disabled]="quantity() >= currentStockQuantity()"
                >
                  +
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Add to Cart Button -->
        <div class="mb-3 d-flex flex-column gap-2">
          <button
            class="btn btn-primary w-100"
            [disabled]="!canAddToCart() || isAddingToCart()"
            (click)="addToCart()"
          >
            @if (isAddingToCart()) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Adding...
            } @else {
              Add to Cart
            }
          </button>
          <button type="button" class="btn btn-outline-secondary w-100" (click)="goBack()">
            Continue Shopping
          </button>
        </div>
        <div class="small text-muted">
          Tip: Choose variant options to see price/stock update instantly.
        </div>
      </div>
    </div>
  </div>
}

@if (!isLoading() && !product()) {
  <div class="container text-center py-5">
    <h2>Product Not Found</h2>
    <p class="text-muted">The product you're looking for doesn't exist.</p>
    <a routerLink="/products" class="btn btn-primary">Browse Products</a>
  </div>
}
